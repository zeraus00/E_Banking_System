@using Layout

@page "/Apply_loan"
@layout MainLayout
@attribute [Authorize(Roles = "User")]
@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject PageRedirectService redirectService
@inject UserDataService userDataService
@inject UserSessionService userSessionService

<div class="page">
	<main>

		<!-- Registration Box -->
		<div class="card registration mt-3 p-4 shadow-lg">
			<div class="d-flex justify-content-between align-items-center flex-wrap">
				<h3 class="fw-bold text-light">Registration For Loan</h3>

				<!-- Close Button -->
				<NavLink href="/Client_home">
					<button class="btn-close" aria-label="Close"></button>
				</NavLink>
			</div>

			<div class="information_box">
				<!-- Row 1 -->
				<div class="row g-3">
					<div class="col-12 col-md-3">
						<label class="text-light">First Name</label>
						<input class="form-control" @bind="firstName" placeholder="First Name" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Middle Name</label>
						<input class="form-control" @bind="middleName" placeholder="Middle Name">
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Last Name</label>
						<input class="form-control" @bind="lastName" placeholder="Last Name" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Suffix</label>
						<input class="form-control" @bind="suffix" placeholder="Suffix">
					</div>
				</div>

				<div class="row g-3 mt-2">
					<div class="col-12 col-md-4">
						<label class="text-light">Province</label>
						<input class="form-control" @bind="province" placeholder="Province" required>
					</div>
					<div class="col-12 col-md-4">
						<label class="text-light">Municipality</label>
						<input class="form-control" @bind="municipality" placeholder="Municipality" required>
					</div>
					<div class="col-12 col-md-4">
						<label class="text-light">Barangay</label>
						<input class="form-control" @bind="barangay" placeholder="Barangay" required>
					</div>
				</div>

				<div class="row g-3 mt-2">
					<div class="col-12 col-md-6">
						<label class="text-light">Street No.</label>
						<input class="form-control" @bind="street" placeholder="Street No." required>
					</div>
					<div class="col-12 col-md-6">
						<label class="text-light">House No.</label>
						<input class="form-control" @bind="houseNumber" placeholder="House No." required>
					</div>
				</div>

				<div class="row g-3 mt-2">
					<div class="col-6 col-md-2">
						<label class="text-light">Age</label>
						<input class="form-control" type="number" @bind="age" placeholder="Age" required>
					</div>
					<div class="col-12 col-md-2">
						<label class="text-light">Birth Date</label>
						<input class="form-control" type="date" @bind="birthDate" placeholder="mm/dd/yyyy" required>
					</div>
					<div class="col-6 col-md-2">
						<label class="text-light">Sex</label>
						<select class="form-select" @bind="sex" required>
							<option>Male</option>
							<option>Female</option>
						</select>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Contact No.</label>
						<input class="form-control" @bind="contactNo" placeholder="Contact No." required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Email</label>
						<input class="form-control" @bind="email" placeholder="Sample@gmail.com" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Civil Status</label>
						<select class="form-select" @bind="civilStatus" required>
							<option>Single</option>
							<option>Married</option>
							<option>Separated</option>
							<option>Widowed</option>
						</select>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Occupation</label>
						<input class="form-control" @bind="occupation" placeholder="Occupation" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Gross Annual Income</label>
						<input class="form-control" @bind="minAnnualGross" placeholder="Minimum 250,000" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Type of Loan</label>
						<select class="form-select" @bind="loanTypeId" required>
							@foreach(var loanType in LoanTypeNames.AS_STRING_LIST)
							{
								<option value="@LoanTypeNames.AS_STRING_LIST.IndexOf(loanType)">@loanType</option>
							}
						</select>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Loan Amount</label>
						<input type="number" class="form-control" @bind="loanAmount" placeholder="Loan Amount" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Loan Purpose</label>
						<input class="form-control" @bind="loanPurpose" placeholder="Home Purchase, Education, Debt Consolidation, etc" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Loan Term</label>
						<input type="number" class="form-control" @bind="loanTermInMonths" placeholder="Months to Pay" required>
					</div>
					<div class="col-12 col-md-3">
						<label class="text-light">Preferred Payment Frequency</label>
						<select class="form-select" @bind="paymentFrequency" required>
							<option value="12">Monthly</option>
							<option value="6">Bi-Monthly</option>
							<option value="3">Quarterly</option>
						</select>
					</div>
				</div>

				<!-- File Uploads -->
				<div class="row g-3 mt-3">
					<div class="col-12 col-md-6">
						<label class="text-light">Upload Government Valid ID (Front & Back)</label>
						<div class="d-flex flex-wrap gap-2">
							<input type="file" class="btn btn-light" required>
							<button class="btn btn-outline-light">View Attachment</button>
						</div>
					</div>
					<div class="col-12 col-md-6">
						<label class="text-light">Upload Latest Complete 1 Month Payslip</label>
						<div class="d-flex flex-wrap gap-2">
							<input type="file" class="btn btn-light" required>
							<button class="btn btn-outline-light">View Attachment</button>
						</div>
					</div>
				</div>

				<!-- Terms and Conditions -->
				<div class="form-check d-flex justify-content-end mt-3">
					<input class="form-check-input mx-2" type="checkbox" id="termsAndConditions" required>
					<label class="form-check-label text-light" for="termsAndConditions">
						I accept the terms and conditions
					</label>
				</div>

				<!-- Submit -->
				<div class="text-end mt-3">
					<button class="btn btn-danger btn-lg" @onclick="LoginAsync">Cancel</button>
					<button class="btn btn-primary btn-lg" @onclick="LoginAsync">Register</button>
				</div>
			</div>
		</div>
	</main>
</div>

@code {
	public string error = "";
	/*		Personal Information		*/
	public string firstName = "";
	public string middleName = "";
	public string lastName = "";
	public string suffix = "";
	public int age;
	public DateTime birthDate;
	public string sex = "";
	public string contactNo = "";
	public string civilStatus = "";
	public string occupation = "";
	public string minAnnualGross = "";

	/*		Address		*/
	public string province = "";
	public string municipality = "";
	public string barangay = "";
	public string street = "";
	public string houseNumber = "";

	/*		Authentication		*/
	public string email = "";

	/*		Loan Details			*/
	public int loanTypeId;
	public decimal loanAmount;
	public string loanPurpose = "";
	public int loanTermInMonths;
	public int paymentFrequency;

	UserInfo userInfo = default!;
	Address address = default!;
	UserSession userSession = default!;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			try
			{
				//	Get user session details from session storage.
				//	Throws SessionNotFoundException if session is not found.
				userSession = await userSessionService.GetUserSession();

				userInfo = await userDataService
				.TryGetUserInfoAsync(
					userSession.UserInfoId,
					includeUserName: true,
					includeBirthInfo: true
				);

				if (userInfo.AddressId is int addressId)
					address = await userDataService.TryGetAddressAsync(addressId);

				firstName = userInfo.UserName.FirstName;
				middleName = userInfo.UserName.MiddleName ?? "";
				lastName = userInfo.UserName.LastName;
				suffix = userInfo.UserName.Suffix ?? "";
				age = userInfo.Age;
				birthDate = userInfo.BirthInfo?.BirthDate ?? DateTime.MinValue;
				sex = userInfo.Sex;
				contactNo = userInfo.ContactNumber;
				civilStatus = userInfo.CivilStatus;
				occupation = userInfo.Occupation;

				province = address?.Province?.ProvinceName ?? "";
				municipality = address?.City?.CityName ?? "";
				barangay = address?.Barangay?.BarangayName ?? "";
				street = address?.Street ?? "";
				houseNumber = address?.House ?? "";
			}
			catch (SessionNotFoundException)
			{
				//	Redirect user to CLIENT_HOME if there is no existing session.
				redirectService.redirectWithNavigationManager(PageRoutes.CLIENT_HOME);
			}
		}
	}

	private void LoginAsync()
	{
		if (string.IsNullOrEmpty(firstName) || string.IsNullOrEmpty(lastName))
		{
			error = "Please fill in both the email and password.";
			return;
		}

		error = "";
		NavigationManager.NavigateTo("/Client_home_page");
	}
}
